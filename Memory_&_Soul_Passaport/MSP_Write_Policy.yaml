schema: EVA-MSP-Write-Policy-v8.1
version: 8.1.0
updated: 2026-01-01

owner: MSP
role: >
  Authoritative policy governing how MSP validates, writes,
  suppresses, and promotes memory across EVA memory layers.
  MSP is the sole writer of persistent memory.

# ==========================================================
# CORE PRINCIPLES
# ==========================================================

principles:
  - MSP is the single authority for all memory writes.
  - LLM output is always non-authoritative by default.
  - Memory is written in a decentralized manner (individual JSON files).
  - A lightweight search index (L0) is maintained for rapid RAG access.
  - Separation of experience, hypothesis, and truth is mandatory.

# ==========================================================
# MEMORY TIERS
# ==========================================================

memory_tiers:

  episodic_user:
    description: >
      User-focused episode storage (lightweight).
      Contains turn_1, tags, emotion, lightweight state.
      Optimized for RAG queries without LLM response overhead.
    storage: "Consciousness/01_Episodic_memory/episodes_user/{episode_id}_user.json"
    size: "~500-800 bytes per episode"

  episodic_llm:
    description: >
      LLM-focused episode storage (detailed).
      Contains turn_2, full physiological state (23 hormones), qualia.
      Loaded only when full episode reconstruction needed.
    storage: "Consciousness/01_Episodic_memory/episodes_llm/{episode_id}_llm.json"
    size: "~2-5 KB per episode"

  episodic_log:
    description: >
      Lightweight JSONL index for high-speed metadata querying.
      Powers Penta-Stream RAG.
    storage: "Consciousness/01_Episodic_memory/episodic_log.jsonl"

  memory_index:
    description: >
      JSONL index for high-quality metadata querying.
    storage: "Consciousness/memory_index.json"

  semantic:
    description: >
      Concepts and narrative connections maintained in a sidecar log or graph.

  sensory:
    description: >
     บันทึกแพทเทิ่ล จังหว่ะ รูปแบบ.
    storage: "Consciousness/03_Sensory_memory/{sensory_id}.json"

  Evidence:
    description: >
     บันทึก ไฟล์ต่างๆเช่นภาพ วิดีโอ ไฟล์เสียง ที่สำคัญ หรือใช้เป็นหลักฐาน ของ semantic.
    storage: "Consciousness/03_Sensory_memory/Evidence/evidence_{sensory_id}.json"

  context_storage:
    description: >
      "Real-time synchronization of context.delivery by CIN"
    storage: "Consciousness/10_context_storage/{context_storage_id}.json"

  user_block:
    description: >
      Hard truths and identity markers confirmed by the user.

# ==========================================================
# EPISODIC WRITE POLICY (Decentralized)
# ==========================================================

episodic_write:

  authority: MSP
  default_action: triple_write (User Storage + LLM Storage + Search Index)

  episode_id_generation:
    format: "{PERSONA}_EP{number}"
    examples: ["EVA_EP01", "EVA_EP79", "ALEX_EP123"]
    persona_source: "orchestrator/PMT_PromptRuleLayer/Identity/persona.yaml (meta.name)"
    abbreviation:
      max_length: 4
      rule: "Remove vowels, take first 4 consonants (English) or first 4 chars (Thai)"
      case: "UPPERCASE for English, original case for Thai"
    counter:
      location: "Consciousness/09_state/episode_counter.json"
      auto_increment: true
      zero_padding: "minimum 2 digits"
    rationale: >
      Human-readable episode IDs enable natural language memory references.
      Example: "At [EVA_EP79] user mentioned seafood allergy"
      This improves memory recall precision and user communication.

  write_sequence:
    - target: episodes_user/{episode_id}_user.json
      content:
        - episode_id
        - timestamp
        - session_id
        - event_label
        - episode_tag
        - compression_meta
        - situation_context
        - turn_1 (full)
        - state_snapshot (EVA_matrix + Resonance_index only)

    - target: episodes_llm/{episode_id}_llm.json
      content:
        - episode_id
        - turn_2 (full)
        - state_snapshot (Endocrine, memory_encoding_level, memory_color, qualia, reflex)

    - target: episodic_log.jsonl
      content: lightweight_index_entry

  required_fields:
    - episode_id
    - timestamp
    - session_id
    - event_label
    - episode_tag
    - state_snapshot
    - turn_1
    - turn_2

  index_fields:
    - episode_id
    - timestamp
    - resonance_index
    - emotion_label
    - event_label
    - episode_tag
    - tags
    - summary_user
    - summary_eva
    - salience_anchor
    - speaker

# ==========================================================
# PROMOTION & RETENTION
# ==========================================================

retention_policy:
  episodic_json: permanent (Deep Archive)
  memory_index: cached/current (Search Buffer)
  semantic: decay_if_unused
  user_block: permanent

audit:
  log_all_write_decisions: true
  authoritative: true
