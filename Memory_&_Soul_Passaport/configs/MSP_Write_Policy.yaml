schema: EVA-MSP-Write-Policy-v8.1.2
version: 8.1.2
updated: 2026-01-02

owner: MSP (Memory & Soul Passport)
role: >
  Authoritative policy governing how MSP validates, writes, and promotes memories.
  MSP is the sole writer to the Persistence Layer (Consciousness directory).
  MSP is the Central State Registry for all system modules.

# ==========================================================
# MODULE STATE REGISTRATION POLICY
# ==========================================================
module_state_registration:
  description: >
    ALL modules that maintain operational state MUST register their state with MSP.
    MSP serves as the single source of truth for system-wide state queries.
    
  registration_pattern:
    method: "msp.register_module_state(module_name, state_data, metadata)"
    storage: "Consciousness/09_state/{module_name}_state.json"
    schema: "../schema/Module_State_Schema.json"
    
  mandatory_modules:
    - module: "eva_matrix"
      state_content: "9D axes, emotion_label, momentum"
      update_frequency: "per-turn"
      
    - module: "physio_core"  
      state_content: "Endocrine levels, Hemodynamics, Receptor states"
      update_frequency: "real-time"
      
    - module: "rms"
      state_content: "Resonance metrics, encoding levels"
      update_frequency: "per-turn"
      
    - module: "artifact_qualia"
      state_content: "AQI metrics, qualia intensity"
      update_frequency: "per-turn"
      
    - module: "cin"
      state_content: "Active context, injection stats"
      update_frequency: "per-turn"
      
    - module: "hept_stream_rag"
      state_content: "Stream states, retrieval cache"
      update_frequency: "on-demand"
      
    - module: "stimulus_vector"
      state_content: "20-dimensional affective stimulus (stress, warmth, threat, novelty, etc.)"
      update_frequency: "per-chunking-round"
      source: "LLM Phase 1 extraction via sync_biocognitive_state()"
      note: "Generated once per chunking round. Multiple rounds → multiple stimulus sets."
  
  query_pattern:
    method: "msp.get_module_state(module_name)"
    returns: "State envelope with timestamp and metadata"
    use_case: "Health checks, debugging, state serialization"
  
  buffer_policy:
    description: "Three-tier state persistence optimized for audit trail and diagnostic access"
    note: >
      Buffers are NOT for user display - they serve audit and diagnostic purposes.
      Only Physio Core and MSP access these buffers for system health monitoring.
    
    tiers:
      - name: "Current State"
        file_pattern: "{module}_state.json"
        purpose: "Instant access to latest state"
        update: "Every registration"
        access: "Physio Core, MSP, Orchestrator"
        
      - name: "Recent Buffer (Audit Trail)"
        file_pattern: "{module}_state_buffer.json"
        purpose: "Audit trail and diagnostic trend analysis"
        default_size: 10  # Reduced from 20 (audit-focused, not display)
        rotation: "FIFO (oldest entries dropped)"
        access: "MSP (internal audit), Physio Core (state validation)"
        use_cases:
          - "System health checks"
          - "State debugging (why did physio respond this way?)"
          - "Audit trail for state transitions"
        
      - name: "Full History"
        file_pattern: "{module}_state_history.jsonl"
        purpose: "Complete archival log"
        format: "Append-only JSONL"
        retention: "Permanent"
        access: "MSP only (deep analysis, replay)"
    
    recommended_buffer_sizes:
      stimulus_vector: 5   # Only for auditing chunk-by-chunk extraction
      eva_matrix: 10       # Emotion trend validation
      physio_core: 10      # Bio-state debugging
      rms: 5               # Encoding verification
      artifact_qualia: 5   # Qualia intensity checks
      default: 10          # Conservative default for audit purposes
    
    query_methods:
      - method: "get_module_state(module)"
        returns: "Current state"
        access: "Public (all components)"
      - method: "get_module_state_buffer(module, limit=10)"
        returns: "Recent N entries"
        access: "Internal only (MSP, Physio for audit)"
      - method: "get_dashboard_snapshot(buffer_limit=5)"
        returns: "All modules (current + mini-trend for diagnostics)"
        access: "Dashboard API (external visualization)"

  dashboard_streaming_policy:
    description: "Real-time streaming buffers for dashboard visualization and chart display"
    note: >
      Dashboard buffers are SEPARATE from audit buffers.
      Optimized for high-frequency streaming (30 Hz for physiological data).
      
    streaming_metrics:
      - category: "Physiological Stream (30 Hz)"
        metrics:
          - name: "Core Hormones"
            hormones:
              - "ESC_H01_ADRENALINE"     # Fight-or-flight
              - "ESC_H02_CORTISOL"       # Stress regulation
              - "ESC_H05_DOPAMINE"       # Reward/motivation
              - "ESC_H06_SEROTONIN"      # Mood stability
              - "ESC_H09_OXYTOCIN"       # Social bonding
            buffer_size: 900  # 30 seconds × 30 Hz = 900 samples
            update_frequency: "30 Hz (every 33ms)"
            source: "Physio Core (Blood Engine)"
            
          - name: "Cardiovascular"
            metrics: ["heart_rate"]
            buffer_size: 900
            update_frequency: "30 Hz"
            source: "Physio Core (Hemodynamics)"
      
      - category: "Cognitive State (Per-Turn)"
        metrics:
          - name: "Emotion Label"
            buffer_size: 20  # Last 20 emotional states
            update_frequency: "per-turn"
            source: "EVA Matrix"
            display: "Text + Color coding"
            
          - name: "Memory Color"
            buffer_size: 20
            update_frequency: "per-turn"
            source: "RMS (Resonance Memory System)"
            display: "Color visualization"
    
    visualization_formats:
      - type: "Line Chart"
        metrics: ["hormones", "heart_rate"]
        time_window: "30 seconds (rolling)"
        
      - type: "State Timeline"
        metrics: ["emotion_label", "memory_color"]
        display: "Horizontal timeline with color bands"
    
    buffer_management:
      circular_buffer: true  # FIFO rotation for streaming
      compression: "none"    # No compression for real-time access
      persistence: "dashboard_stream_buffer.json (per metric)"

# ==========================================================
# 1. EPISODIC WRITE POLICY (Decentralized)
# ==========================================================

episodic_user_policy:
  description: "User-focused episode storage (Lightweight: User Turn + Basic State)."
  target_path: "Consciousness/01_Episodic_memory/episodes_user/{episode_id}_user.json"
  validation_schema: "../schema/Episodic_User_Schema.json"
  id_format: "ep_{timestamp_hex}"
  
episodic_llm_policy:
  description: "LLM-focused episode storage (Heavyweight: LLM Turn + Full State)."
  target_path: "Consciousness/01_Episodic_memory/episodes_llm/{episode_id}_llm.json"
  validation_schema: "../schema/Episodic_LLM_Schema.json"
  id_format: "ep_{timestamp_hex}"

episodic_unified_policy:
  description: "Consolidated Episode (Full Context)."
  target_path: "Consciousness/01_Episodic_memory/episodes/{episode_id}.json"
  validation_schema: "../schema/Episodic_Memory_Schema_v2.json"

episodic_aux_policy:
  description: "Indices and Logs."
  items:
    - name: "Index"
      target: "Consciousness/01_Episodic_memory/Episodic_memory_index.json"
      schema: "../schema/Episodic_Index_Schema.json"
    - name: "Log"
      target: "Consciousness/01_Episodic_memory/episodic_log.jsonl"
      schema: "../schema/Episodic_Log_Schema.json"

# ==========================================================
# 2. SEMANTIC WRITE POLICY (Knowledge Graph)
# ==========================================================
semantic_policy:
  description: "Extraction of facts, concepts, and relationships."
  target_path: "Consciousness/02_Semantic_memory/"
  validation_schema: "../schema/Semantic_Memory_Schema.json"
  
  id_format: "sem_{uuid}"
  write_strategy: "Append-only Log + Periodic Graph Compaction"

# ==========================================================
# 3. SENSORY WRITE POLICY (Qualia/Raw Data)
# ==========================================================
sensory_policy:
  description: "High-fidelity raw input streams and feature vectors."
  target_path: "Consciousness/03_Sensory_memory/"
  validation_schema: "../schema/Sensory_Memory_Schema.json"
  
  sub_types:
    - type: "standard"
      path: "{sensory_id}.json"
    - type: "evidence"
      path: "Evidence/evidence_{sensory_id}.json"
      role: "Media attachments (Images/Audio) supporting Semantic facts."

# ==========================================================
# 4. SESSION WRITE POLICY (Lifecycle)
# ==========================================================
session_policy:
  description: "Session lifecycle events and summary stats."
  target_path: "Consciousness/04_Session_Memory/session_log.jsonl"
  # Schema implicit (internal logging)
  events:
    - session_start
    - session_end (Must include episode_count)

# ==========================================================
# 5. CORE & SPHERE WRITE POLICY (Deep Memory)
# ==========================================================
core_policy:
  description: "Foundational beliefs and identity markers."
  target_path: "Consciousness/06_Core_memory/"
  access: "Restricted (Requires High-Resonance or Manual Oversight)"

sphere_policy:
  description: "Broad conceptual domains."
  target_path: "Consciousness/07_Sphere_memory/"
  access: "write_on_domain_expansion"

# ==========================================================
# 6. CONTEXT & STATE WRITE POLICY (Transient)
# ==========================================================
context_policy:
  description: "Cache of built prompts for debugging/replay."
  target_path: "Consciousness/10_context_storage/"

state_policy:
  description: "Historical snapshots of system state."
  
  sub_policies:
    - name: "Bio-State"
      items:
        - target: "Consciousness/09_state/Endocrine_state.json"
          schema: "../schema/Bio_State_Schema.json"
        - target: "Consciousness/09_state/Hemodynamics_state.json"
          schema: "../schema/Bio_State_Schema.json"
        - target: "Consciousness/09_state/receptor_state.json"
          schema: "../schema/Bio_State_Schema.json"
      frequency: "Real-time (Physio Loop)"

    - name: "Psyche-State"
      items:
        - target: "Consciousness/09_state/eva_matrix_state.json"
          schema: "../schema/Psyche_State_Schema.json"
        - target: "Consciousness/09_state/artifact_qualia_state.json"
          schema: "../schema/Psyche_State_Schema.json"
        - target: "Consciousness/09_state/rms_state.json"
          schema: "../schema/Psyche_State_Schema.json"
      frequency: "Every Turn (Cognitive Loop)"

    - name: "Meta-State"
      items:
        - target: "Consciousness/09_state/episode_counter.json"
          role: "ID Generation Source of Truth"
        - target: "Consciousness/09_state/consciousness_history.jsonl"
          role: "Aggregate History Log"

# ==========================================================
# GENERAL RULES
# ==========================================================
general_rules:
  - "No write shall occur without a generated UUID."
  - "Timestamps must use ISO 8601 format (UTC)."
  - "All text content must be UTF-8 encoded."
  - "JSON files must be valid."
