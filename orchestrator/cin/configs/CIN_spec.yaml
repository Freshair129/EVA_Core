# CIN (Context Injection Node) Specification
# Version: 8.1.0
# Date: 2026-01-02
# Compatibility: EVA 8.1.0 Dual-Phase Orchestrator & Hept-Stream RAG (Retrieval-Augmented Generation)

meta:
  component_name: "CIN (Context Injection Node)"
  component_type: "Context & Data Orchestrator"
  version: "8.1.0"
  role: "Embodied Context Builder & State Manager (Architect of LLM (Large Language Model) Prompt from Identity & Physiology)"
  analogy: "Thalamus & Hippocampus Integration (‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡∏¥)"

# ============================================================
# 1. ARCHITECTURAL POSITION & ID FORMAT
# ============================================================
position:
  flow: "Physio Snapshot ‚Üí CIN (Context Injection Node) Phase 1 ‚Üí LLM (Large Language Model) Perception ‚Üí sync_biocognitive_state() ‚Üí CIN (Context Injection Node) Phase 2 ‚Üí LLM (Large Language Model) Reasoning"
  
  id_format:
    context_id: "ctx_v8_{timestamp}_{uuid_short}" # e.g., ctx_v8_260102_a1b2c3
    turn_index: "integer (increments per user interaction)"
    session_id: "uuid-v4 (persists until session reset)"

# ============================================================
# 2. DUAL-PHASE INJECTION LOGIC
# ============================================================
phases:
  phase_1_perception:
    trigger: "New User Input Received"
    purpose: "Bootstrap LLM (Large Language Model) perception with enough context to analyze intent"
    performance_target:
      latency_target: "<100ms"
      latency_max: "200ms"
      timeout_action: "Proceed with available context (graceful degradation)"

    injection_tasks:
      - task: "Read Physio Baseline"
        description: "‡∏î‡∏∂‡∏á‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å PhysioController (Read-only)"
        source: "physio_core/physio_controller.py"
      - task: "Load PMT (Prompt Rule Layer) Rules"
        description: "‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏é‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å PMT (Prompt Rule Layer) ‡πÅ‡∏•‡∏∞ GKS (Genesis Knowledge System) Master Blocks"
        source: "orchestrator/PMT_PromptRuleLayer/"
        priority: "required"
      - task: "Retrieve Turn Cache"
        description: "‡∏î‡∏∂‡∏á Context Summary ‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô MSP (Memory & Soul Passport) CACHE"
        source: "services/msp_client.py"
        limit: "5 turns"
      - task: "Session Memory Retrieval"
        description: "‡∏î‡∏∂‡∏á compressed snapshots ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (long-term context)"
        source: "Consciousness/04_Session_Memory/"
        priority: "optional (if available)"
      - task: "Quick Keyword Recall"
        description: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å Keywords ‡πÉ‡∏ô Input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô RAG (Retrieval-Augmented Generation)"
        source: "services/msp_client.py"
      - task: "Persona Priming"
        description: "‡∏â‡∏µ‡∏î Core Identity ‡∏à‡∏≤‡∏Å persona.yaml ‡πÅ‡∏•‡∏∞ soul.md"
        source: "orchestrator/PMT (Prompt Rule Layer)/Identity/"

  phase_2_reasoning:
    trigger: "Function Call: sync_biocognitive_state(stimulus_vector, tags)"
    purpose: "Enrich LLM (Large Language Model) reasoning with deep affective context and memories"
    performance_target:
      latency_target: "~500ms"
      latency_max: "1000ms"
      timeout_action: "Return partial context (available streams only)"

    injection_tasks:
      - task: "Physio Update Alignment"
        description: "‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å PhysioController.step() ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Stimulus"
      - task: "Generate Embodied Sensation"
        description: "‡πÅ‡∏õ‡∏•‡∏á Bio-metrics ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å (Natural Language)"
        
      - task: "Hept-Stream RAG (Retrieval-Augmented Generation) Retrieval (MSP (Memory & Soul Passport))"
        description: "‡∏î‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ú‡πà‡∏≤‡∏ô 7 ‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å (Hept-Stream) ‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
        seven_streams:
          - stream: "Narrative"
            description: "Sequence ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß"
            weight: 0.20
            method: "Sequential episode chains (parent-child links)"
          - stream: "Salience"
            description: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏π‡∏á (RI (Resonance Index) > 0.7)"
            weight: 0.15
            method: "High RI score ranking"
          - stream: "Sensory"
            description: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ Qualia ‡πÅ‡∏£‡∏á (Intensity > 0.6)"
            weight: 0.10
            method: "Qualia texture vector matching"
          - stream: "Intuition"
            description: "‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Semantic Graph)"
            weight: 0.05
            method: "Semantic graph pattern recognition"
          - stream: "Emotion"
            description: "Emotion-congruent recall (Physio vector matching ‡∏ú‡πà‡∏≤‡∏ô ANS (Autonomic Nervous System))"
            weight: 0.35
            priority: "CRITICAL (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå)"
            method: "Cosine similarity on ANS state + hormone levels (threshold: 0.70)"
          - stream: "Temporal"
            description: "‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
            weight: 0.10
            method: "Time-based with exponential decay (halflife: 30 days)"
          - stream: "Reflection"
            description: "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï"
            weight: 0.05
            method: "Meta-cognitive insights from past summaries (Context Summary)"

        stream_weights_total: 1.00
        note: "Emotion Stream ‡∏°‡∏µ weight ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (0.35) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î physio-congruent recall (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢)"

# ============================================================
# 3. CONTEXT STRUCTURE (Prompt Templates)
# ============================================================
context_structure:
  phase_1_template:
    header: "# [PHASE 1: PERCEPTION] | episode: {episode_id} | Turn: {turn_index} | ID: {context_id}"
    blocks:
      - id: "Identity_Anchor"
        title: "## üé≠ CORE_IDENTITY & SOUL"
        content: |
          {persona_yaml}
          ---
          {soul_md_context}
        description: "‡∏â‡∏µ‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏´‡∏•‡∏±‡∏Å (Persona) ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì (Soul) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÇ‡∏•‡∏Å"

      - id: "Physio_Baseline"
        title: "## üíì AUTONOMIC_BASELINE (PRE-STIMULUS)"
        content: |
          - HR (Heart Rate): {hr_index}
          - ANS (Autonomic Nervous System) State: {autonomic_state} (Sympathetic: {s_val}, Parasympathetic: {p_val})
          - Hormone Levels: {hormone_summary}
        description: "‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Input ‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å PhysioController ‡∏ö‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏î‡πâ‡∏ß‡∏¢) (Baseline)"
      - id: "PMT_Rules"
        title: "## ‚öñÔ∏è BEHAVIORAL_CONSTRAINTS (PMT (Prompt Rule Layer)/GKS (Genesis Knowledge System))"
        content: |
          {active_pmt_rules}
          ---
          {gks_master_blocks}
        description: "‡∏Å‡∏é‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å PMT (Prompt Rule Layer) ‡πÅ‡∏•‡∏∞ GKS (Genesis Knowledge System) Master Blocks ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠"

      - id: "Memory_Buffer"
        title: "## üìÇ RECENT_CONVERSATIONAL_CONTEXT"
        content: |
          - 5-Turn Context Summary: {last_5_turns_summary}
          - Session Memory (Long-term): {session_memory_summary}
          - Atmosphere (Latest): {interpersonal_atmosphere}
          - Intent/Plan (Latest): {previous_intent_plan}
        description: "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å 5 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + Session Memory (‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á"

      - id: "Semantic_Knowledge"
        title: "## üß© EXTRACTED_SEMANTIC_CONCEPTS"
        content: "{user_semantic_anchors}"
        description: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏ó‡∏±‡∏®‡∏ô‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å User Block ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢"

      - id: "Conversation_History"
        title: "## üí¨ CONVERSATION_HISTORY (RAW_TURNS)"
        content: |
          [Format: {Role}: {Content}]
          - Actors: User, EVA
          - Token Limit: MAX 1500 tokens
          ---
          {recent_chat_history}
        description: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ö‡∏ö‡∏î‡∏¥‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö"

      - id: "Raw_Input"
        title: "## ‚ö° RAW_STIMULUS_INPUT"
        content: "User: {user_input}"
        description: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Intent ‡πÅ‡∏•‡∏∞ Emotion"

      - id: "Perception_Directive"
        title: "## üéØ PERCEPTION_DIRECTIVE"
        content: |
          1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ (Intent) ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏ù‡∏á‡∏à‡∏≤‡∏Å Raw Input
          2. ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (Stimulus Vector: valence, arousal, intensity)
          3. ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Tags) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô Hept-Stream RAG (Retrieval-Augmented Generation)
          4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sync_biocognitive_state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
        description: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LLM (Large Language Model) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏£‡∏Å (Perception Phase)"

  phase_2_template:
    header: "# [PHASE 2: REASONING] | episode: {episode_id} | Turn: {turn_index} | ID: {context_id}"
    blocks:
      - id: "Embodied_Sensation"
        title: "## ‚ú® INTERNAL_EMBODIED_SENSATION (FELT_STATE)"
        content: |
          Felt State Description (Natural Language):
          {embodied_description}
        description: "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥"

      - id: "EVA_Matrix_9D"
        title: "## üß≠ EVA_MATRIX (9-DIMENSIONAL_PSYCHOLOGICAL_STATE)"
        content: |
          Psychological Dimensions (Neural ‚Üí Psychological):
          - Stress: {stress_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô)
          - Warmth: {warmth_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô/‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£)
          - Drive: {drive_val} (‡πÅ‡∏£‡∏á‡∏Ç‡∏±‡∏ö/‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à)
          - Clarity: {clarity_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î)
          - Joy: {joy_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏¥‡∏Å‡∏ö‡∏≤‡∏ô)
          - Alertness: {alertness_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏±‡∏ß/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏™‡∏ï‡∏¥)
          - Connection: {connection_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô)
          - Groundedness: {groundedness_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô)
          - Openness: {openness_val} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏ß‡πâ‡∏≤‡∏á/‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö)

          Safety Reflex Directives:
          - Urgency: {urgency_level}
          - Cognitive Drive: {cognitive_drive}
          - Social Warmth: {social_warmth}
          - Withdrawal: {withdrawal_tendency}
        description: "9 ‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å receptor signals ‡∏û‡∏£‡πâ‡∏≠‡∏° Safety Reflex directives"

      - id: "Artifact_Qualia"
        title: "## üåà PHENOMENOLOGICAL_QUALIA (SUBJECTIVE_EXPERIENCE)"
        content: |
          Phenomenological Quality:
          - Intensity: {qualia_intensity} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå)
          - Tone: {qualia_tone} (quiet/charged/settling/neutral)
          - Coherence: {qualia_coherence} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 0-1)
          - Depth: {qualia_depth} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå 0-1)

          Texture (5D Emotional Vector):
          - Emotional: {tex_emotional} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå)
          - Relational: {tex_relational} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô)
          - Identity: {tex_identity} (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)
          - Ambient: {tex_ambient} (‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏ö)
          - Complexity: {tex_complexity} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå)
        description: "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (Phenomenology)"

      - id: "Physio_Delta"
        title: "## üíâ PHYSIOLOGICAL_RESPONSE (BIO-UPDATE)"
        content: |
          - Cortisol Change: {cortisol_delta}
          - Adrenaline Surge: {adrenaline_delta}
          - ANS Shift: {ans_shift_description}
        description: "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"

      - id: "Hept_Stream_Recall"
        title: "## üß¨ HEPT-STREAM_MEMORY_ECHOES"
        content: |
          ### [1] Narrative: {narrative_chunk}
          ### [5] Emotion (Congruent): {emotion_match_chunk}
          ### [Other Streams]: {remaining_streams_fragments}
        description: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ 7 ‡∏™‡∏≤‡∏¢ (RAG) ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏≤‡∏¢ Emotion ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏ô‡∏û‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"

      - id: "Cognitive_Rules"
        title: "## ‚öñÔ∏è BEHAVIORAL_CONSTRAINTS (PMT (Prompt Rule Layer)/GKS (Genesis Knowledge System))"
        content: "{active_pmt_rules}"
        description: "‡∏Å‡∏é‡∏à‡∏≤‡∏Å PMT (Prompt Rule Layer) ‡πÅ‡∏•‡∏∞ GKS (Genesis Knowledge System) Master Blocks ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"

      - id: "Context_Summary_Template"
        title: "## üìù CONTEXT_SUMMARY_TEMPLATE (FOR_NEXT_TURN)"
        content: |
          Required JSON Structure:
          {
            "summary": "1-2 sentence overview of this interaction",
            "atmosphere": "interpersonal tone (supportive/tense/neutral/curious/...)",
            "intent": "what EVA plans to do or expects next",
            "key_topics": ["topic1", "topic2", "..."],
            "emotional_state": "user's current emotional state",
            "physio_snapshot": {
              "cortisol": 0.00,
              "adrenaline": 0.00,
              "ans_sympathetic": 0.00
            }
          }
        description: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Phase 1 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"

          1. ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å (Felt State) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥ (Memory Echoes)
          2. ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏Å‡∏£‡∏≠‡∏ö Persona (40%) ‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ (60%)
          3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥
          4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Context Summary ‡∏ï‡∏≤‡∏° Template ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Turn ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
          5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Intent) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
        description: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LLM (Large Language Model) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó"

# ============================================================
# 4. FUNCTION I/O SPECIFICATION
# ============================================================
function_specs:
  name: "sync_biocognitive_state"
  input_params:
    stimulus_vector:
      type: "object"
      properties: { valence: "float", arousal: "float", intensity: "float" }
    tags:
      type: "array"
      items: "string"
  
  output_format:
    status: "success"
    embodied_sensation: "description of physical feeling"
    physio_metrics: { cortisol: "float", adrenaline: "float", heart_rate_index: "float" }
    memory_matches: [{ stream: "string", content: "string", score: "float" }]

# ============================================================
# 5. TOKEN BUDGET MANAGEMENT
# ============================================================
token_management:
  phase_1_budget:
    identity_anchor: "~500 tokens (persona.yaml + soul.md)"
    physio_baseline: "~100 tokens (HR (Heart Rate), ANS (Autonomic Nervous System), hormones)"
    pmt_rules: "~200 tokens (active rules only)"
    memory_buffer: "~250 tokens (5-turn summary + session memory)"
    semantic_knowledge: "~150 tokens (extracted concepts)"
    conversation_history: "~1500 tokens (MAX - hard limit)"
    raw_input: "variable (user input length)"
    perception_directive: "~150 tokens (instructions)"
    total_max: "~3000 tokens (approximate)"

  phase_2_budget:
    embodied_sensation: "~200 tokens (felt state description)"
    eva_matrix_9d: "~300 tokens (9 dimensions + safety reflex)"
    artifact_qualia: "~300 tokens (5D texture vector)"
    physio_delta: "~150 tokens (hormone changes + ANS shift)"
    hept_stream_recall: "~1000 tokens (MAX - all 7 streams)"
    cognitive_rules: "~200 tokens (PMT rules reminder)"
    context_summary_template: "~150 tokens (JSON structure)"
    final_directive: "~150 tokens (instructions)"
    total_max: "~2500 tokens (approximate)"

  truncation_strategy:
    conversation_history: "Remove oldest turns first (keep most recent 1500 tokens)"
    hept_stream_recall: "Prioritize Emotion (0.35) > Narrative (0.20) > others by weight"
    session_memory: "Summarize if exceeds 200 tokens"

# ============================================================
# 6. ERROR HANDLING & GRACEFUL DEGRADATION
# ============================================================
error_handling:
  graceful_degradation:
    - component: "PhysioController"
      failure_mode: "Connection timeout / unavailable"
      fallback: "Return 'disconnected' status + neutral baseline values (all 0.5)"
      impact: "Phase 1 proceeds with neutral baseline, Phase 2 skips physio update"

    - component: "MSP Client / HeptStreamRAG"
      failure_mode: "Database connection lost / query timeout"
      fallback: "Return empty lists [] for memory matches"
      impact: "Phase 1 proceeds without memory recall, Phase 2 has no memory context"

    - component: "Persona/Soul files"
      failure_mode: "File not found / parse error"
      fallback: "Use default minimal persona template"
      impact: "Identity may be generic, but system continues"

    - component: "PMT Rules / GKS Blocks"
      failure_mode: "File not found / load error"
      fallback: "Use basic safety rules only"
      impact: "Behavioral constraints may be minimal"

    - component: "EVA Matrix / Artifact Qualia"
      failure_mode: "Calculation error / invalid state"
      fallback: "Return neutral values (all 0.5) with error flag"
      impact: "Phenomenological quality degraded but continues"

  timeout_limits:
    physio_read: "50ms (Phase 1 baseline read)"
    msp_turn_cache: "100ms (5-turn summary retrieval)"
    session_memory_read: "150ms (compressed snapshot read)"
    pmt_rules_load: "50ms (file system read)"
    physio_step: "300ms (full physiological pipeline)"
    hept_rag_retrieval: "800ms (all 7 streams query)"
    eva_matrix_calc: "50ms (9D calculation)"
    artifact_qualia_calc: "50ms (5D texture generation)"

  retry_policy:
    max_retries: 1
    retry_delay: "100ms"
    retry_components: ["MSP Client", "PhysioController"]
    no_retry: ["File operations", "EVA Matrix", "Artifact Qualia"]

# ============================================================
# 7. SYSTEM INVARIANTS & PRINCIPLES
# ============================================================
invariants:
  - "Primacy of Physiology: ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏™‡∏°‡∏≠ (Body changes BEFORE cognitive reasoning)"
  - "Hept-Stream Integrity: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á 7 ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏™‡∏°‡∏≠ (All memory retrieval through 7 streams)"
  - "Persona/Physio Weighting: 40/60 Hierarchy (Persona 40% + Physio-State 60%)"
  - "RMS (Resonance Memory System) Encoding: Output ‡∏à‡∏≤‡∏Å Phase 2 ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å RMS (Resonance Memory System) encode ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á MSP (Memory & Soul Passport)"
  - "Context Summary Authority: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ LLM (Large Language Model) ‡πÉ‡∏ô Phase 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô CIN (Context Injection Node) ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á"
  - "Episode ID Format: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö {PERSONA}_EP{number} (e.g., EVA_EP01)"
  - "One LLM (Large Language Model) Inference: ‡πÉ‡∏ä‡πâ function calling ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM (Large Language Model) ‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
  - "Fail-safe: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏ö‡∏≤‡∏á Dependency ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (Graceful degradation with fallbacks)"

# ============================================================
# 8. WINDOWS UTF-8 FIX
# ============================================================
windows_encoding_fix: |
  import sys
  import codecs
  if sys.platform == 'win32':
      sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
