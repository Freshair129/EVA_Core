# CIN (Context Injection Node) Specification
# Version: 8.1.0
# Date: 2025-12-31
# Compatibility: EVA 8.1.0 Dual-Phase Orchestrator (Physio-Streaming) & MSP v8.0

meta:
  component_name: "Context Injection Node (CIN)"
  component_type: "Context & Data Orchestrator"
  version: "8.1.0"
  role: "Embodied Context Builder & State Manager"
  analogy: "Thalamus & Hippocampus Integration (ตัวเชื่อมประสาทสัมผัส ความจำ และสติ)"

# ============================================================
# 1. ARCHITECTURAL POSITION & ID FORMAT
# ============================================================
position:
  flow: "Physio Snapshot → CIN Phase 1 → LLM Perception → sync_biocognitive_state() → CIN Phase 2 → LLM Reasoning"
  
  id_format:
    context_id: "ctx_v8_{timestamp}_{uuid_short}" # e.g., ctx_v8_20251231_a1b2c3
    turn_index: "integer (increments per user interaction)"
    session_id: "uuid-v4 (persists until session reset)"

# ============================================================
# 2. DUAL-PHASE INJECTION LOGIC
# ============================================================
phases:
  phase_1_perception:
    trigger: "New User Input Received"
    performance_target:
      latency: "<100ms"
      accuracy: "Low (surface-level, keyword matching)"
      purpose: "Bootstrap LLM perception with enough context to analyze"

    injection_tasks:
      - task: "Read Physio Baseline"
        description: "ดึงค่าปัจจุบันจาก BloodEngine, ReceptorEngine และ AutonomicState"
        fallback: "Return status='disconnected' if PhysioController unavailable"

      - task: "Retrieve Turn Cache"
        description: "ดึง Context Summary จาก turn_index - 1 ใน MSP_EPISODIC"
        limit: "5 recent turns (summaries only, not full episodes)"
        fallback: "Return empty list if MSP unavailable"

      - task: "Quick Keyword Recall"
        description: "Simple keyword matching for fast surface-level memory access"
        strategy: "Extract keywords from user input, match against episode tags"
        fallback: "Return empty list if MSP unavailable"

      - task: "Retrieve Semantic Concepts"
        description: "Related concepts from semantic graph"
        limit: "5 most relevant concepts"
        fallback: "Return empty list if MSP unavailable"

      - task: "Persona Priming"
        description: "ฉีด Core Identity จาก Persona_01.md"
        auto_discovery: "Search EVA 8.1.0/User_profile/ → EVA 8.0/User_profile/"
        fallback: "Use embedded default persona if file not found"

  phase_2_reasoning:
    trigger: "Function Call: sync_biocognitive_state(stimulus_vector, tags)"
    performance_target:
      latency: "~500ms"
      accuracy: "High (deep, emotion-congruent)"
      purpose: "Retrieve memories matching embodied state for authentic response"

    injection_tasks:
      - task: "Physio Update Signal"
        description: "ส่ง stimulus_vector ให้ HPARegulator ประมวลผลเป็นเวลา N ms (Virtual Time)"
        target: "PhysioController.step(stimulus_vector)"
        pipeline: "HPA → Endocrine → Blood → Receptor → ANS"

      - task: "Read Emergent State"
        description: "อ่านค่า Blood/ANS ใหม่ที่เปลี่ยนแปลงหลังจากได้รับแรงกระตุ้น"
        snapshot_fields:
          - "blood_levels: {cortisol, adrenaline, dopamine, serotonin}"
          - "ans_state: {sympathetic, parasympathetic, heart_rate_index}"
          - "receptor_signals: transduced neural signals"

      - task: "Generate Embodied Sensation"
        description: "แปลง physio metrics เป็นคำอธิบายความรู้สึกทางกายแบบ natural language"
        examples:
          - "cortisol > 0.7: 'รู้สึกตึงเครียด มีความกังวลในร่างกาย'"
          - "adrenaline > 0.6: 'หัวใจเต้นเร็วขึ้น พร้อมจะตอบสนอง'"
          - "ans_sympathetic > 0.7: 'ระบบประสาทกระตุ้นสูง (Sympathetic)'"

      - task: "Hept-Stream RAG Retrieval (MSP)"
        description: "ค้นหาความจำผ่าน 7 สาย (Narrative, Salience, Sensory, Intuition, Emotion, Temporal, Reflection) อิงตาม ANS State"
        key_stream: "Emotion Stream (ความจำที่มีอารมณ์ตรงกับร่างกายปัจจุบัน)"
        emotion_stream_strategy:
          method: "Cosine similarity on physiological vectors"
          threshold: "0.7 (70% similarity)"
          vectors: "ans_sympathetic, cortisol, adrenaline, dopamine, serotonin"
        max_results_per_stream: 3
        temporal_decay: "Exponential decay with 30-day halflife"

# ============================================================
# 3. CONTEXT STRUCTURE (Prompt Template - Dual Phase)
# ============================================================
# โครงสร้างที่ CIN จะฉีดเข้าไปใน LLM แบ่งตามจังหวะการรับรู้
context_structure:
  phase_1_template:
    header: "# [PHASE 1: PERCEPTION] | ID: {context_id} | TURN: {turn_index}"
    blocks:
      - id: "Identity"
        content: "## IDENTITY_CORE\n{persona_data}"
      - id: "Body_Baseline"
        content: "## INITIAL_BODY_STATE\n- Blood: {hormone_levels}\n- ANS: {autonomic_state}"
      - id: "Short_Term_Buffer"
        content: "## RECENT_HISTORY (MSP_CACHE)\n{context_summary_prev}"
      - id: "Input"
        content: "## RAW_STIMULUS\nUser: {user_input}"

  phase_2_template:
    header: "# [PHASE 2: REASONING] | ID: {context_id}"
    blocks:
      - id: "Embodied_Sensation"
        content: "## INTERNAL_SENSATION (FELT_STATE)\n- Feeling: {embodied_description}\n- Bio_Metrics: {physio_metrics}"
      - id: "Memory_Echoes"
        content: "## MSP_HEPT_STREAM_RECALL\n{memory_fragments_from_7_streams}"
      - id: "Reflective_Directive"
        content: "## COGNITIVE_DIRECTIVE\nIntegrate feelings and memories into final response."

# ============================================================
# 4. MSP INTEGRATION & STORAGE LOGIC
# ============================================================
# การจัดเก็บข้อมูลลง MSP หลังจากจบเทิร์น
msp_storage_mapping:
  episodic:
    collection: "episodes_v8"
    data:
      - "context_id"
      - "user_input"
      - "final_response"
      - "physio_trace (initial vs final)"
  semantic:
    collection: "semantic_graph"
    data: "new candidates/concepts extracted from summary"
  sensory:
    collection: "sensory_log"
    data: "emotion_texture (High-fidelity vectors for recall)"
  memory_cache:
    collection: "turn_cache"
    data:
      - "summary (from LLM Phase 2 self-reflection)"
      - "tags (semantic markers for future retrieval)"
    purpose: "Fast context bootstrap for next turn's Phase 1"

# ============================================================
# 5. FUNCTION I/O SPECIFICATION
# ============================================================
function_specs:
  name: "sync_biocognitive_state"
  input_params:
    stimulus_vector:
      type: "object"
      properties: { valence: "float", arousal: "float", intensity: "float" }
    tags:
      type: "array"
      items: "string"
  
  output_format:
    status: "success"
    embodied_sensation: "description of physical feeling based on new ANS state"
    physio_metrics: { cortisol: "float", adrenaline: "float", heart_rate_index: "float" }
    memory_matches: [{ stream: "string", content: "string", score: "float" }]

# ============================================================
# 6. SYSTEM INVARIANTS & ERROR HANDLING
# ============================================================
invariants:
  - "CIN จะไม่สรุปเอง: Summary ต้องมาจาก LLM Phase 2 เท่านั้น"
  - "Context Continuity: context_id ต้องคงที่ตลอดทั้ง 2 Phase ใน 1 Turn"
  - "MSP Primacy: การเรียกข้อมูลต้องผ่าน Hept-Stream Retrieval เสมอ"
  - "Response Weighting: Persona 40% + Physio-State 60% (Physiology drives response more than identity)"
  - "Two-Level Retrieval: Phase 1 rough/fast (keyword) + Phase 2 deep/accurate (emotion-congruent)"

error_handling:
  physio_timeout: "ใช้ค่า Snapshot ล่าสุด และติด Flag [PHYSIO_DISCONNECTED]"
  msp_failure: "ใช้ Local Cache และติด Flag [MEMORY_LOCAL_ONLY]"
  persona_not_found: "Use embedded fallback persona (EVA 8.1.0 basic identity)"
  llm_timeout: "Return cached response or generic acknowledgment"

# ============================================================
# 7. IMPLEMENTATION NOTES
# ============================================================
implementation:
  class_name: "ContextInjectionNode"
  file_location: "orchestrator/cin.py"

  key_methods:
    - name: "generate_context_id()"
      returns: "str (ctx_v8_{yymmdd}_{hhmmss}_{hash})"
      description: "Generate unique ID for this turn, stays constant across both phases"

    - name: "inject_phase_1(user_input: str)"
      returns: "Dict[str, Any]"
      description: "Build Phase 1 context (rough/fast retrieval)"
      latency_target: "<100ms"

    - name: "inject_phase_2(stimulus, tags, updated_physio, memory_matches)"
      returns: "Dict[str, Any]"
      description: "Build Phase 2 context (deep/accurate retrieval)"
      latency_target: "~500ms"

    - name: "build_phase_1_prompt(context: Dict)"
      returns: "str"
      description: "Format Phase 1 context as LLM prompt"

    - name: "build_phase_2_prompt(context: Dict)"
      returns: "str"
      description: "Format Phase 2 context as function result"

  dependencies:
    required:
      - "Persona file (Persona_01.md)" # with fallback
    optional:
      - "PhysioController" # graceful degradation
      - "MSP Client" # graceful degradation
      - "HeptStreamRAG" # graceful degradation

  design_principles:
    - "READ-ONLY access to memory (CIN never writes to episodic log)"
    - "Graceful degradation (works with missing dependencies)"
    - "Fail-safe defaults (embedded persona, empty lists, disconnected status)"
    - "Thai/English bilingual (UTF-8 encoding on Windows required)"

# ============================================================
# 8. INTEGRATION EXAMPLE
# ============================================================
integration_example: |
  # Initialize CIN with dependencies
  cin = ContextInjectionNode(
      persona_path=Path("User_profile/Persona_01.md"),  # optional, auto-discovery
      physio_controller=physio_core,                     # optional
      msp_client=msp,                                    # optional
      hept_stream_rag=rag                                # optional
  )

  # Phase 1: Rough retrieval
  phase_1_ctx = cin.inject_phase_1(user_input="วันนี้เครียดมาก งานเยอะอะ")
  phase_1_prompt = cin.build_phase_1_prompt(phase_1_ctx)

  # LLM processes and calls function
  llm_response = llm.generate(
      prompt=phase_1_prompt,
      tools=[sync_biocognitive_state_tool]
  )

  # If function called (The Gap):
  if llm_response.tool_calls:
      stimulus_vector = llm_response.tool_calls[0].args["stimulus_vector"]
      tags = llm_response.tool_calls[0].args["tags"]

      # PhysioController updates body state
      updated_physio = physio_controller.step(stimulus_vector)

      # HeptRAG retrieves emotion-congruent memories
      memory_matches = rag.retrieve({
          "tags": tags,
          "ans_state": updated_physio["autonomic"],
          "blood_levels": updated_physio["blood"]
      })

      # Phase 2: Deep injection
      phase_2_ctx = cin.inject_phase_2(
          stimulus_vector, tags, updated_physio, memory_matches
      )
      function_result = cin.build_phase_2_prompt(phase_2_ctx)

      # LLM continues with enriched context
      final_response = llm.continue_with_result(function_result)

# ============================================================
# 9. WINDOWS UTF-8 ENCODING FIX
# ============================================================
windows_encoding_fix: |
  # Required for Thai character support on Windows console
  import sys
  import codecs

  if sys.platform == 'win32':
      sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')